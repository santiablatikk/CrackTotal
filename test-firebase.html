<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Firebase - Crack Total</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .test-section.error {
            border-left-color: #f44336;
        }
        .test-section.warning {
            border-left-color: #ff9800;
        }
        .status {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üî• Test de Firebase - Crack Total</h1>
    
    <div class="test-section">
        <div class="status" id="connectionStatus">üîÑ Verificando conexi√≥n...</div>
        <div id="connectionDetails"></div>
    </div>

    <div class="test-section">
        <div class="status" id="configStatus">üîÑ Verificando configuraci√≥n...</div>
        <div id="configDetails"></div>
    </div>

    <div class="test-section">
        <div class="status" id="rulesStatus">üîÑ Verificando reglas de seguridad...</div>
        <div id="rulesDetails"></div>
    </div>

    <div class="test-section">
        <div class="status" id="dataStatus">üîÑ Verificando datos de prueba...</div>
        <div id="dataDetails"></div>
        <button onclick="testUserCreation()">Crear Usuario de Prueba</button>
        <button onclick="testMatchSave()">Guardar Partida de Prueba</button>
        <button onclick="testRankingQuery()">Consultar Rankings</button>
    </div>

    <div class="test-section">
        <div class="status">üìä Logs del Sistema</div>
        <pre id="systemLogs"></pre>
        <button onclick="clearLogs()">Limpiar Logs</button>
    </div>

    <script type="module">
        import { db } from './assets/js/firebase-init.js';
        import { 
            doc, 
            getDoc, 
            setDoc, 
            collection, 
            addDoc,
            query,
            orderBy,
            limit,
            getDocs,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { ensureUserProfile, saveQuienSabeMasResult } from './assets/js/firebase-utils.js';

        let logs = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateLogsDisplay();
            console.log(`[Firebase Test] ${message}`);
        }

        function updateLogsDisplay() {
            document.getElementById('systemLogs').textContent = logs.slice(-20).join('\n');
        }

        window.clearLogs = function() {
            logs = [];
            updateLogsDisplay();
        }

        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            const detailsEl = document.getElementById('connectionDetails');
            
            try {
                if (!db) {
                    throw new Error('Base de datos no inicializada');
                }

                // Test b√°sico de conectividad
                const testRef = doc(db, 'gameConfig', 'test');
                await getDoc(testRef);
                
                statusEl.innerHTML = '‚úÖ <span class="success">Conexi√≥n exitosa</span>';
                detailsEl.innerHTML = `
                    <p>‚úÖ Firebase inicializado correctamente</p>
                    <p>‚úÖ Firestore accesible</p>
                    <p>üìç Proyecto: cracktotal-cd2e7</p>
                `;
                addLog('Conexi√≥n a Firebase exitosa', 'success');
                
            } catch (error) {
                statusEl.innerHTML = '‚ùå <span class="error">Error de conexi√≥n</span>';
                detailsEl.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                addLog(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        async function testConfiguration() {
            const statusEl = document.getElementById('configStatus');
            const detailsEl = document.getElementById('configDetails');
            
            try {
                // Verificar configuraciones de juego
                const gameTypes = ['quiensabemas', 'mentiroso', 'crackrapido', 'pasalache'];
                let configResults = [];
                
                for (const gameType of gameTypes) {
                    const configRef = doc(db, 'gameConfig', gameType);
                    const configSnap = await getDoc(configRef);
                    
                    if (configSnap.exists()) {
                        configResults.push(`‚úÖ ${gameType}: Configurado`);
                        addLog(`Configuraci√≥n ${gameType} encontrada`, 'success');
                    } else {
                        configResults.push(`‚ùå ${gameType}: No configurado`);
                        addLog(`Configuraci√≥n ${gameType} faltante`, 'warning');
                    }
                }
                
                statusEl.innerHTML = '‚úÖ <span class="success">Configuraci√≥n verificada</span>';
                detailsEl.innerHTML = configResults.map(r => `<p>${r}</p>`).join('');
                
            } catch (error) {
                statusEl.innerHTML = '‚ùå <span class="error">Error en configuraci√≥n</span>';
                detailsEl.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                addLog(`Error verificando configuraci√≥n: ${error.message}`, 'error');
            }
        }

        async function testSecurityRules() {
            const statusEl = document.getElementById('rulesStatus');
            const detailsEl = document.getElementById('rulesDetails');
            
            try {
                // Test de lectura de colecciones p√∫blicas
                const matchesRef = collection(db, 'matches');
                const matchesQuery = query(matchesRef, limit(1));
                await getDocs(matchesQuery);
                
                statusEl.innerHTML = '‚úÖ <span class="success">Reglas funcionando</span>';
                detailsEl.innerHTML = `
                    <p>‚úÖ Lectura de matches permitida</p>
                    <p>‚úÖ Reglas de seguridad activas</p>
                `;
                addLog('Reglas de seguridad funcionando correctamente', 'success');
                
            } catch (error) {
                if (error.code === 'permission-denied') {
                    statusEl.innerHTML = '‚ö†Ô∏è <span class="warning">Permisos restringidos</span>';
                    detailsEl.innerHTML = `<p class="warning">Las reglas est√°n activas pero muy restrictivas</p>`;
                    addLog('Reglas muy restrictivas detectadas', 'warning');
                } else {
                    statusEl.innerHTML = '‚ùå <span class="error">Error en reglas</span>';
                    detailsEl.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                    addLog(`Error en reglas: ${error.message}`, 'error');
                }
            }
        }

        window.testUserCreation = async function() {
            try {
                addLog('Iniciando test de creaci√≥n de usuario...', 'info');
                const userId = await ensureUserProfile();
                addLog(`Usuario creado/verificado: ${userId}`, 'success');
                alert('‚úÖ Usuario de prueba creado exitosamente');
            } catch (error) {
                addLog(`Error creando usuario: ${error.message}`, 'error');
                alert('‚ùå Error creando usuario: ' + error.message);
            }
        }

        window.testMatchSave = async function() {
            try {
                addLog('Iniciando test de guardado de partida...', 'info');
                const gameStats = {
                    result: 'victory',
                    myScore: 1500,
                    opponentId: 'test_opponent',
                    opponentName: 'Oponente de Prueba',
                    opponentScore: 1200
                };
                
                const success = await saveQuienSabeMasResult(gameStats);
                if (success) {
                    addLog('Partida de prueba guardada exitosamente', 'success');
                    alert('‚úÖ Partida de prueba guardada exitosamente');
                } else {
                    throw new Error('La funci√≥n retorn√≥ false');
                }
            } catch (error) {
                addLog(`Error guardando partida: ${error.message}`, 'error');
                alert('‚ùå Error guardando partida: ' + error.message);
            }
        }

        window.testRankingQuery = async function() {
            try {
                addLog('Iniciando test de consulta de rankings...', 'info');
                const usersRef = collection(db, 'users');
                const rankingQuery = query(
                    usersRef, 
                    orderBy('stats.quiensabemas.score', 'desc'),
                    limit(5)
                );
                
                const snapshot = await getDocs(rankingQuery);
                addLog(`Rankings consultados: ${snapshot.size} usuarios encontrados`, 'success');
                
                let rankingData = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    rankingData.push({
                        name: data.displayName,
                        score: data.stats?.quiensabemas?.score || 0
                    });
                });
                
                alert(`‚úÖ Rankings consultados: ${rankingData.length} usuarios\n${rankingData.map((u, i) => `${i+1}. ${u.name}: ${u.score} pts`).join('\n')}`);
                
            } catch (error) {
                addLog(`Error consultando rankings: ${error.message}`, 'error');
                alert('‚ùå Error consultando rankings: ' + error.message);
            }
        }

        // Ejecutar tests autom√°ticamente
        document.addEventListener('DOMContentLoaded', async () => {
            addLog('Iniciando tests autom√°ticos de Firebase...', 'info');
            
            // Esperar un poco para que Firebase se inicialice
            setTimeout(async () => {
                await testConnection();
                await testConfiguration();
                await testSecurityRules();
                addLog('Tests autom√°ticos completados', 'info');
            }, 2000);
        });
    </script>
</body>
</html> 