import{initializeApp,getApps,getApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getFirestore}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{getAuth,signInAnonymously,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";import{getFirebaseConfig}from"./firebase-config.js";let app,db,auth,dbInstance=null,authInstance=null,firebaseUser=null,isFirebaseInitializing=!1,firebaseInitializationPromise=null;async function initializeFirebase(){return isFirebaseInitializing||(isFirebaseInitializing=!0,firebaseInitializationPromise=(async()=>{try{const e=await getFirebaseConfig();if(!e||!e.apiKey)throw console.error("âŒ ConfiguraciÃ³n de Firebase invÃ¡lida o no cargada desde firebase-config.js"),new Error("ConfiguraciÃ³n de Firebase invÃ¡lida");return console.log("ğŸ”¥ Inicializando Firebase con la configuraciÃ³n obtenida..."),app=getApps().length?getApp():initializeApp(e),dbInstance=getFirestore(app),authInstance=getAuth(app),console.log("âœ… Firebase App inicializada correctamente."),console.log("ğŸ“‹ Project ID:",app.options.projectId),new Promise(((e,r)=>{onAuthStateChanged(authInstance,(r=>{r?(firebaseUser=r,console.log("ğŸ‘¤ Usuario autenticado:",r.isAnonymous?"AnÃ³nimo":r.uid),e({app:app,db:dbInstance,auth:authInstance,user:firebaseUser})):(console.log("ğŸ”‘ No hay usuario. Intentando autenticaciÃ³n anÃ³nima..."),signInAnonymously(authInstance).then((r=>{firebaseUser=r.user,console.log("ğŸ‘¤ Usuario anÃ³nimo autenticado:",firebaseUser.uid),e({app:app,db:dbInstance,auth:authInstance,user:firebaseUser})})).catch((r=>{console.error("âŒ Error en autenticaciÃ³n anÃ³nima:",r),console.warn("âš ï¸ Funcionando en modo solo lectura debido a error de autenticaciÃ³n"),firebaseUser={uid:"guest_"+Date.now(),isAnonymous:!0,displayName:"Invitado",readOnly:!0},e({app:app,db:dbInstance,auth:authInstance,user:firebaseUser,readOnly:!0})})))}),(r=>{console.error("âŒ Error en onAuthStateChanged:",r),console.warn("âš ï¸ Funcionando en modo solo lectura debido a error en observador de autenticaciÃ³n"),firebaseUser={uid:"guest_"+Date.now(),isAnonymous:!0,displayName:"Invitado",readOnly:!0},e({app:app,db:dbInstance,auth:authInstance,user:firebaseUser,readOnly:!0})}))}))}catch(e){console.error("âŒ Error CRÃTICO inicializando Firebase en firebase-init.js:",e),window.dispatchEvent(new CustomEvent("firebaseError",{detail:e})),console.warn("âš ï¸ Inicializando Firebase en modo de emergencia (datos de demostraciÃ³n)");return{app:null,db:createMockFirestore(),auth:{currentUser:{uid:"mock_user",isAnonymous:!0}},user:{uid:"mock_user",isAnonymous:!0,displayName:"Usuario Demo"},isMock:!0}}})()),firebaseInitializationPromise}function createMockFirestore(){return{collection:e=>({doc:e=>({get:()=>Promise.resolve({exists:!1,data:()=>null}),set:()=>Promise.resolve(),update:()=>Promise.resolve()}),where:()=>({orderBy:()=>({limit:()=>({get:()=>Promise.resolve({docs:getMockDocuments(e)})})})}),orderBy:()=>({limit:()=>({get:()=>Promise.resolve({docs:getMockDocuments(e)})})})})}}function getMockDocuments(e){return({users:[{id:"mock1",displayName:"Demo User 1",score:1200,wins:5,losses:2},{id:"mock2",displayName:"Demo User 2",score:950,wins:3,losses:1}],rankings:[{id:"rank1",userId:"mock1",displayName:"Demo User 1",score:1200,gameType:"pasalache"},{id:"rank2",userId:"mock2",displayName:"Demo User 2",score:950,gameType:"pasalache"}],matches:[{id:"match1",userId:"mock1",playerName:"Demo User 1",score:300,result:"victory"},{id:"match2",userId:"mock2",playerName:"Demo User 2",score:250,result:"defeat"}]}[e]||[]).map((e=>({id:e.id,data:()=>e})))}export const ensureFirebaseInitialized=async()=>authInstance&&dbInstance?Promise.resolve({app:app,db:dbInstance,auth:authInstance,user:firebaseUser}):initializeFirebase();ensureFirebaseInitialized().then((e=>{db=e.db,auth=e.auth,console.log("Firebase db y auth disponibles para exportaciÃ³n directa (despuÃ©s de promesa)."),window.dispatchEvent(new CustomEvent("firebaseReady",{detail:{db:db,auth:auth,user:e.user}}))})).catch((e=>{console.error("Error finalizando la inicializaciÃ³n de Firebase para exportaciÃ³n directa:",e),window.dispatchEvent(new CustomEvent("firebaseError",{detail:e}))}));export{db,auth};export function isFirebaseAvailable(){return null!==dbInstance&&null!==authInstance&&null!==firebaseUser}export function isUserAuthenticated(){return null!==firebaseUser}export function getCurrentUser(){return firebaseUser}export async function safeFirestoreOperation(e,r=null){if(!isFirebaseAvailable())return console.warn("ğŸ”¥ Firebase no disponible, saltando operaciÃ³n"),r&&r(),null;try{return await e()}catch(e){return console.error("ğŸš« Error en operaciÃ³n de Firestore:",e.code,e.message),"permission-denied"===e.code?(console.error("ğŸš« FIRESTORE: Permisos insuficientes. Posibles soluciones:"),console.error("   1. Habilitar autenticaciÃ³n anÃ³nima en Firebase Console"),console.error("   2. Ajustar reglas de seguridad de Firestore"),console.error("   3. Verificar configuraciÃ³n del proyecto")):"unavailable"===e.code?console.error("ğŸŒ FIRESTORE: Servicio no disponible. Verifica conectividad"):"deadline-exceeded"===e.code?console.error("â±ï¸ FIRESTORE: Timeout en la operaciÃ³n. ConexiÃ³n lenta"):"failed-precondition"===e.code&&console.error("âš™ï¸ FIRESTORE: Reglas de seguridad muy restrictivas"),r&&r(),null}}"undefined"!=typeof window&&(window.isFirebaseAvailable=isFirebaseAvailable,window.isUserAuthenticated=isUserAuthenticated,window.getCurrentUser=getCurrentUser,window.safeFirestoreOperation=safeFirestoreOperation);