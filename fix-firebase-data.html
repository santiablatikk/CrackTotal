<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reparaci√≥n Firebase - Crack Total</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0f0f0f;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #1a1a1a;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            border: 2px solid #ff6b6b;
        }
        .title {
            color: #ff6b6b;
            font-size: 28px;
            margin-bottom: 20px;
            text-align: center;
        }
        .subtitle {
            color: #feca57;
            font-size: 20px;
            margin: 20px 0;
        }
        .log {
            background: #000;
            padding: 20px;
            border-radius: 8px;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 400px;
            font-size: 13px;
            border: 1px solid #333;
        }
        .button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 10px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .button:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }
        .button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .progress {
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-bar {
            background: linear-gradient(90deg, #00ff00, #feca57);
            height: 25px;
            width: 0%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
        }
        .success { color: #00ff00; }
        .error { color: #ff6b6b; }
        .warning { color: #feca57; }
        .info { color: #74b9ff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
            <div class="title">üîß REPARACI√ìN FIREBASE - CRACK TOTAL</div>
            <p class="info">Esta herramienta ayuda a migrar y normalizar las partidas existentes en Firebase para que aparezcan correctamente en el ranking.</p>
            
            <div class="subtitle">üéØ Opciones de Reparaci√≥n</div>
            <button class="button" onclick="scanAllData()">üîç Escanear Todos los Datos</button>
            <button class="button" onclick="migrateOldStructure()">üì¶ Migrar Estructura Antigua</button>
            <button class="button" onclick="fixPlayerAssociation()">üë§ Reparar Asociaci√≥n de Jugadores</button>
            <button class="button" onclick="createMissingIndexes()">üìä Crear √çndices Faltantes</button>
            <button class="button" onclick="fullRepair()">üöÄ Reparaci√≥n Completa</button>
        </div>

        <div class="section">
            <div class="subtitle">üìä Progreso de Reparaci√≥n</div>
            <div class="progress">
                <div id="progress-bar" class="progress-bar">0%</div>
            </div>
            <div id="status" class="info">Listo para iniciar...</div>
        </div>

        <div class="section">
            <div class="subtitle">üìù Log de Actividad</div>
            <div id="activity-log" class="log">üîß Herramienta de reparaci√≥n Firebase cargada.
Selecciona una opci√≥n para comenzar...</div>
        </div>

        <div class="section">
            <div class="subtitle">üìà Resultados del Escaneo</div>
            <div id="scan-results" class="log">No hay resultados a√∫n...</div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <!-- Configuraci√≥n Firebase -->
    <script src="assets/js/firebase-config.js"></script>

    <script>
        let repairLog = [];
        let totalOperations = 0;
        let completedOperations = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            repairLog.push(logMessage);
            
            const logDiv = document.getElementById('activity-log');
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            
            logDiv.innerHTML += `\n<span class="${colorClass}">${logMessage}</span>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(logMessage);
        }

        function updateProgress(percentage, status) {
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-bar').textContent = Math.round(percentage) + '%';
            document.getElementById('status').textContent = status;
        }

        async function scanAllData() {
            log("üîç Iniciando escaneo completo de datos...", 'info');
            updateProgress(0, "Iniciando escaneo...");

            try {
                // Verificar conexi√≥n
                if (!window.db) {
                    throw new Error("Firebase no est√° conectado");
                }

                let scanResults = "üîç RESULTADOS DEL ESCANEO:\n\n";
                
                updateProgress(10, "Verificando colecciones...");
                
                // Escanear colecci√≥n matches
                log("üìä Escaneando colecci√≥n 'matches'...");
                const matchesSnapshot = await window.db.collection('matches').get();
                scanResults += `üéÆ PARTIDAS:\n`;
                scanResults += `  Total: ${matchesSnapshot.size} documentos\n\n`;

                updateProgress(30, "Analizando partidas...");

                // Analizar estructura de partidas
                const gameTypes = new Map();
                const playerIds = new Set();
                const dateFields = new Set();
                let withoutGameType = 0;
                let withoutPlayerId = 0;
                let withoutTimestamp = 0;

                matchesSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Contar por tipo de juego
                    if (data.gameType) {
                        gameTypes.set(data.gameType, (gameTypes.get(data.gameType) || 0) + 1);
                    } else {
                        withoutGameType++;
                    }
                    
                    // Recolectar IDs de jugadores
                    if (data.playerId) {
                        playerIds.add(data.playerId);
                    } else {
                        withoutPlayerId++;
                    }
                    
                    // Verificar campos de fecha
                    if (data.timestamp) dateFields.add('timestamp');
                    if (data.createdAt) dateFields.add('createdAt');
                    if (data.date) dateFields.add('date');
                    if (!data.timestamp && !data.createdAt && !data.date) {
                        withoutTimestamp++;
                    }
                });

                updateProgress(50, "Generando estad√≠sticas...");

                scanResults += `üìä POR TIPO DE JUEGO:\n`;
                for (const [gameType, count] of gameTypes) {
                    scanResults += `  ${gameType}: ${count} partidas\n`;
                }
                
                scanResults += `\nüë• JUGADORES:\n`;
                scanResults += `  √önicos: ${playerIds.size}\n`;
                
                scanResults += `\nüìÖ CAMPOS DE FECHA:\n`;
                for (const field of dateFields) {
                    scanResults += `  ${field}: presente\n`;
                }
                
                scanResults += `\n‚ö†Ô∏è PROBLEMAS DETECTADOS:\n`;
                if (withoutGameType > 0) scanResults += `  Sin gameType: ${withoutGameType}\n`;
                if (withoutPlayerId > 0) scanResults += `  Sin playerId: ${withoutPlayerId}\n`;
                if (withoutTimestamp > 0) scanResults += `  Sin fecha: ${withoutTimestamp}\n`;

                updateProgress(70, "Verificando estad√≠sticas de usuarios...");

                // Escanear user_stats
                const statsSnapshot = await window.db.collection('user_stats').get();
                scanResults += `\nüìà ESTAD√çSTICAS DE USUARIOS:\n`;
                scanResults += `  Total: ${statsSnapshot.size} documentos\n`;

                updateProgress(90, "Finalizando escaneo...");

                // Mostrar resultados
                document.getElementById('scan-results').textContent = scanResults;
                
                updateProgress(100, "Escaneo completado");
                log("‚úÖ Escaneo completado exitosamente", 'success');

            } catch (error) {
                log(`‚ùå Error durante el escaneo: ${error.message}`, 'error');
                updateProgress(0, "Error en el escaneo");
            }
        }

        async function migrateOldStructure() {
            log("üì¶ Iniciando migraci√≥n de estructura antigua...", 'info');
            updateProgress(0, "Preparando migraci√≥n...");

            try {
                const snapshot = await window.db.collection('matches').get();
                totalOperations = snapshot.size;
                completedOperations = 0;

                log(`üìä Encontradas ${totalOperations} partidas para revisar`);

                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    let needsUpdate = false;
                    const updates = {};

                    // Verificar y normalizar gameType
                    if (!data.gameType && data.game) {
                        updates.gameType = data.game;
                        needsUpdate = true;
                    }

                    // Verificar y agregar timestamp si falta
                    if (!data.timestamp && data.createdAt) {
                        const date = new Date(data.createdAt);
                        updates.timestamp = firebase.firestore.Timestamp.fromDate(date);
                        needsUpdate = true;
                    }

                    // Verificar playerName
                    if (!data.playerName && data.player) {
                        updates.playerName = data.player;
                        needsUpdate = true;
                    }

                    // Aplicar actualizaciones si es necesario
                    if (needsUpdate) {
                        await doc.ref.update(updates);
                        log(`‚úÖ Actualizado documento ${doc.id}`, 'success');
                    }

                    completedOperations++;
                    const progress = (completedOperations / totalOperations) * 100;
                    updateProgress(progress, `Migrando... ${completedOperations}/${totalOperations}`);
                }

                log("‚úÖ Migraci√≥n completada exitosamente", 'success');
                updateProgress(100, "Migraci√≥n completada");

            } catch (error) {
                log(`‚ùå Error durante la migraci√≥n: ${error.message}`, 'error');
                updateProgress(0, "Error en la migraci√≥n");
            }
        }

        async function fixPlayerAssociation() {
            log("üë§ Reparando asociaci√≥n de jugadores...", 'info');
            updateProgress(0, "Analizando jugadores...");

            try {
                // Esta funci√≥n ayudar√≠a a asociar partidas hu√©rfanas con usuarios actuales
                // Por ahora, solo analizamos la situaci√≥n
                
                const snapshot = await window.db.collection('matches').get();
                const playerCounts = new Map();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.playerId) {
                        playerCounts.set(data.playerId, (playerCounts.get(data.playerId) || 0) + 1);
                    }
                });

                log(`üìä Encontrados ${playerCounts.size} jugadores √∫nicos`);
                
                // Mostrar top jugadores
                const topPlayers = Array.from(playerCounts.entries())
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);

                for (const [playerId, count] of topPlayers) {
                    log(`üë§ ${playerId}: ${count} partidas`);
                }

                updateProgress(100, "An√°lisis completado");
                log("‚úÖ An√°lisis de jugadores completado", 'success');

            } catch (error) {
                log(`‚ùå Error en an√°lisis de jugadores: ${error.message}`, 'error');
                updateProgress(0, "Error en el an√°lisis");
            }
        }

        async function createMissingIndexes() {
            log("üìä Verificando √≠ndices necesarios...", 'info');
            
            // Los √≠ndices se deben crear desde Firebase Console
            log("‚ÑπÔ∏è Los √≠ndices compuestos deben crearse desde Firebase Console:");
            log("  - matches: gameType + score (desc) + timestamp (desc)");
            log("  - matches: playerId + gameType + timestamp (desc)");
            log("  - matches: timestamp (desc)");
            
            updateProgress(100, "Verificaci√≥n completada");
        }

        async function fullRepair() {
            log("üöÄ Iniciando reparaci√≥n completa...", 'info');
            
            await scanAllData();
            await migrateOldStructure();
            await fixPlayerAssociation();
            await createMissingIndexes();
            
            log("üéâ Reparaci√≥n completa finalizada!", 'success');
        }

        // Inicializaci√≥n
        window.addEventListener('load', () => {
            log("üîß Herramienta de reparaci√≥n Firebase cargada");
            
            // Verificar conexi√≥n al cargar
            setTimeout(() => {
                if (window.db) {
                    log("‚úÖ Conexi√≥n Firebase establecida", 'success');
                } else {
                    log("‚ùå Sin conexi√≥n a Firebase", 'error');
                }
            }, 2000);
        });
    </script>
</body>
</html> 